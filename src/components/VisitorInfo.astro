---
// src/components/VisitorInfo.astro
// è¿™æ˜¯ä¸€ä¸ªæ–°çš„ç»„ä»¶ï¼Œç”¨äºæ˜¾ç¤ºè®¿å®¢ä¿¡æ¯
---

<section class="vh-aside-item">
    <!-- æ–°å¢çš„æ¬¢è¿ä¿¡æ¯å— -->
    <div class="welcome-message">
        <p>ğŸ‘‹ æˆ‘æ˜¯ğ™„ğ™†ğ™ğ™‰ï¼Œä¸€ä¸ªæŠ€æœ¯çˆ±å¥½è€…ï¼Œå–œæ¬¢åˆ†äº«ç»éªŒã€‚ğŸ˜Š</p>
        <p>â“ æœ‰é—®é¢˜æ¬¢è¿æé—®ï¼Œç¡®ä¿å†…å®¹æœ‰æ„ä¹‰ï¼Œè¯¦æƒ…è¯·è§<a href="/tag/ç•™è¨€" target="_message" rel="noopener noreferrer">æé—®çš„æ™ºæ…§</a>ã€‚å¦‚éœ€è”ç³»æˆ‘ï¼Œæ¬¢è¿é€šè¿‡<a href="mailto:admin@204090.xyz">é‚®ç®±è”ç³»æˆ‘</a>ï¼ğŸ“§</p>
    </div>

    <!-- æ ‡é¢˜ï¼Œæ ·å¼å‚è€ƒäº†ä¸»é¢˜ä¸­çš„â€œå…¬å‘Šâ€å— -->
    <span class="visitor-title">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M22 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
        æ¬¢è¿æ¥è®¿!
    </span>

    <!-- ä¿¡æ¯å†…å®¹ -->
    <div class="visitor-content">
        <div class="info-item">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"><path fill="currentColor" d="M12 12.5a3.5 3.5 0 1 0 0-7a3.5 3.5 0 0 0 0 7M10.5 14h3a5.5 5.5 0 0 1 5.5 5.5v1h-14v-1A5.5 5.5 0 0 1 10.5 14M2 12c0 5.523 4.477 10 10 10s10-4.477 10-10S17.523 2 12 2S2 6.477 2 12"></path></svg>
            <span>IP åœ°å€:</span>
            <span id="ip-address">æ­£åœ¨åŠ è½½...</span>
        </div>
        <div class="info-item">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"><path fill="currentColor" d="M12 11.5A2.5 2.5 0 0 1 9.5 9A2.5 2.5 0 0 1 12 6.5A2.5 2.5 0 0 1 14.5 9a2.5 2.5 0 0 1-2.5 2.5M12 2a7 7 0 0 0-7 7c0 5.25 7 13 7 13s7-7.75 7-13a7 7 0 0 0-7-7"></path></svg>
            <span>åœ°ç†ä½ç½®:</span>
            <span id="location">æ­£åœ¨åŠ è½½...</span>
        </div>
        <div class="info-item">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="19" r="3"/><path d="M10.4 16.38L15 10l-2.42-2.42"/></svg>
            <span>ä¸åšä¸»è·ç¦»:</span>
            <span id="distance">æ­£åœ¨è®¡ç®—...</span>
        </div>
        <div class="info-item">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"></path></svg>
            <span>è¿ è¥ å•†:</span>
            <span id="isp">æ­£åœ¨åŠ è½½...</span>
        </div>
        <div class="info-item">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"><path fill="currentColor" d="M2 6v12h20V6zm18 10H4V8h16z"></path></svg>
            <span>æ“ä½œç³»ç»Ÿ:</span>
            <span id="os">æ­£åœ¨åŠ è½½...</span>
        </div>
        <div class="info-item">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"><path fill="currentColor" d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10a10 10 0 0 0 10-10A10 10 0 0 0 12 2m0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8s8 3.59 8 8s-3.59 8-8 8m-4-8a4 4 0 0 1 4-4a4 4 0 0 1 4 4a4 4 0 0 1-4 4a4 4 0 0 1-4-4Z"></path></svg>
            <span>æµ è§ˆ å™¨:</span>
            <span id="browser">æ­£åœ¨åŠ è½½...</span>
        </div>
    </div>

    <!-- å·²ç§»é™¤ canvas å…ƒç´ ï¼Œä¸å†æœ‰èŠ±ç“£èƒŒæ™¯ -->
</section>

<style>
    /* * ä¸ºäº†è®©æ–°å¡ç‰‡æ ·å¼ä¸ä¸»é¢˜èåˆï¼Œè¿™é‡Œåªæ·»åŠ å¿…è¦çš„å¾®è°ƒæ ·å¼ã€‚
        * ä¸»é¢˜çš„ .vh-aside-item åº”è¯¥å·²ç»æä¾›äº†å¡ç‰‡çš„åŸºç¡€æ ·å¼ã€‚
        */
    .vh-aside-item .welcome-message {
        padding-bottom: 0.75rem;
        margin-bottom: 0.75rem;
        border-bottom: 1px solid var(--border-color, #e5e7eb);
        font-size: 0.875rem;
        color: var(--text-color, #374151);
    }
    .vh-aside-item .welcome-message p {
        margin: 0.5rem 0;
        line-height: 1.6;
    }
    .vh-aside-item .welcome-message a {
        color: var(--theme-color, #3eaf7c);
        text-decoration: none;
        font-weight: 600;
    }
    .vh-aside-item .welcome-message a:hover {
        text-decoration: underline;
    }
    .vh-aside-item .visitor-title {
        display: flex;
        align-items: center;
        font-size: 1.1rem; /* 18px */
        font-weight: 600;
        margin-bottom: 0.75rem; /* 12px */
        padding-bottom: 0.75rem;
        border-bottom: 1px solid var(--border-color, #e5e7eb); /* ä½¿ç”¨ä¸»é¢˜çš„è¾¹æ¡†é¢œè‰²å˜é‡, æä¾›å¤‡ç”¨å€¼ */
    }
    .vh-aside-item .visitor-title svg {
        margin-right: 0.5rem; /* 8px */
    }
    .vh-aside-item .visitor-content {
        display: flex;
        flex-direction: column;
        gap: 0.75rem; /* 12px */
    }
    .vh-aside-item .info-item {
        display: flex;
        align-items: center;
        font-size: 0.875rem; /* 14px */
        color: var(--text-color-light, #6b7280); /* ä½¿ç”¨ä¸»é¢˜çš„æ¬¡è¦æ–‡æœ¬é¢œè‰²å˜é‡, æä¾›å¤‡ç”¨å€¼ */
    }
    .vh-aside-item .info-item svg {
        margin-right: 0.75rem; /* 12px */
        flex-shrink: 0;
    }
    .vh-aside-item .info-item span:nth-of-type(1) {
        min-width: 60px;
        color: var(--text-color, #374151); /* ä½¿ç”¨ä¸»é¢˜çš„ä¸»è¦æ–‡æœ¬é¢œè‰²å˜é‡, æä¾›å¤‡ç”¨å€¼ */
    }
</style>

<script>
  // å®¢æˆ·ç«¯è„šæœ¬ï¼Œç”¨äºè·å–å’Œæ˜¾ç¤ºä¿¡æ¯
  document.addEventListener('DOMContentLoaded', () => {
    // =================================================================
    // åœ¨è¿™é‡Œä¿®æ”¹ä¸ºä½ è‡ªå·±æ‰€åœ¨åœ°çš„ç»çº¬åº¦
    const BLOGGER_LAT = 23.0575; // ä¾‹å¦‚ï¼šåŒ—äº¬çš„çº¬åº¦
    const BLOGGER_LON = 112.4536; // ä¾‹å¦‚ï¼šåŒ—äº¬çš„ç»åº¦
    // =================================================================

    // è®¡ç®—ä¸¤ç‚¹é—´è·ç¦»çš„å‡½æ•° (Haversine formula)
    const calculateDistance = (lat1, lon1, lat2, lon2) => {
        const R = 6371; // åœ°çƒåŠå¾„, å•ä½å…¬é‡Œ
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a =
            0.5 - Math.cos(dLat) / 2 +
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
            (1 - Math.cos(dLon)) / 2;
        return Math.round(R * 2 * Math.asin(Math.sqrt(a)));
    };

    // 1. è·å–æ“ä½œç³»ç»Ÿå’Œæµè§ˆå™¨ä¿¡æ¯
    const getOS = () => {
      const ua = navigator.userAgent;
      if (ua.indexOf('Win') !== -1) return 'Windows';
      if (ua.indexOf('Mac') !== -1) return 'MacOS';
      if (ua.indexOf('Linux') !== -1) return 'Linux';
      if (ua.indexOf('Android') !== -1) return 'Android';
      if (ua.indexOf('like Mac') !== -1) return 'iOS';
      return 'Unknown';
    };

    const getBrowser = () => {
      const ua = navigator.userAgent;
      if (ua.indexOf('Chrome') > -1 && ua.indexOf('Safari') > -1 && ua.indexOf('Edge') == -1) return 'Chrome';
      if (ua.indexOf('Safari') > -1 && ua.indexOf('Chrome') == -1) return 'Safari';
      if (ua.indexOf('Firefox') > -1) return 'Firefox';
      if (ua.indexOf('Edge') > -1) return 'Edge';
      return 'Unknown';
    };

    document.getElementById('os').textContent = getOS();
    document.getElementById('browser').textContent = getBrowser();

    // 2. ä½¿ç”¨ç¬¬ä¸‰æ–¹ API è·å– IP å’Œåœ°ç†ä½ç½®ä¿¡æ¯
    fetch('https://ipapi.co/json/')
      .then(response => response.json())
      .then(data => {
        document.getElementById('ip-address').textContent = data.ip || 'è·å–å¤±è´¥';
        document.getElementById('location').textContent = `${data.country_name || ''}, ${data.city || ''}`;
        document.getElementById('isp').textContent = data.org || 'è·å–å¤±è´¥';
        
        // å¦‚æœæˆåŠŸè·å–è®¿å®¢åæ ‡ï¼Œåˆ™è®¡ç®—è·ç¦»
        if (data.latitude && data.longitude) {
            const dist = calculateDistance(BLOGGER_LAT, BLOGGER_LON, data.latitude, data.longitude);
            document.getElementById('distance').textContent = `çº¦ ${dist} å…¬é‡Œ`;
        } else {
            document.getElementById('distance').textContent = 'æ— æ³•è®¡ç®—';
        }
      })
      .catch(error => {
        console.error('Error fetching IP info:', error);
        document.getElementById('ip-address').textContent = 'è·å–å¤±è´¥';
        document.getElementById('location').textContent = 'è·å–å¤±è´¥';
        document.getElementById('isp').textContent = 'è·å–å¤±è´¥';
        document.getElementById('distance').textContent = 'è·å–å¤±è´¥';
      });
  });
</script>
